/**
 * ç»Ÿä¸€è¾“å‡ºæ ¼å¼åŒ–å·¥å…·
 * 
 * è§„åˆ™:
 * 1. æ‰€æœ‰ AI è¾“å‡ºä½¿ç”¨ç®€ä½“ä¸­æ–‡
 * 2. ä½¿ç”¨ Markdown æ ¼å¼
 * 3. Telegram å…¼å®¹çš„ MD æ ¼å¼
 */

/**
 * ç¹ä½“è½¬ç®€ä½“æ˜ å°„è¡¨ï¼ˆæ‰©å±•ç‰ˆï¼‰
 */
const TRAD_TO_SIMP = {
  // ç­¾è¯ç›¸å…³
  'ç°½': 'ç­¾', 'è­‰': 'è¯', 'è­·': 'æŠ¤', 'çºŒ': 'ç»­', 'è¾¦': 'åŠ',
  // å¸¸ç”¨å­—
  'åœ‹': 'å›½', 'é•·': 'é•¿', 'æ™‚': 'æ—¶', 'é–“': 'é—´', 'è²»': 'è´¹',
  'æ©Ÿ': 'æœº', 'å ´': 'åœº', 'é ': 'é¢„', 'è¨‚': 'è®¢', 'éŠ€': 'é“¶',
  'è¬': 'ä¸‡', 'å€‹': 'ä¸ª', 'å•': 'é—®', 'é¡Œ': 'é¢˜', 'è«‹': 'è¯·',
  'èªª': 'è¯´', 'é€™': 'è¿™', 'è£¡': 'é‡Œ', 'æœƒ': 'ä¼š', 'å°': 'å¯¹',
  'å¾Œ': 'å', 'é': 'è¿‡', 'é‚„': 'è¿˜', 'é€²': 'è¿›', 'é–‹': 'å¼€',
  'é—œ': 'å…³', 'é»': 'ç‚¹', 'ç„¡': 'æ— ', 'é›»': 'ç”µ', 'è©±': 'è¯',
  'ç¶²': 'ç½‘', 'é ': 'é¡µ', 'è³‡': 'èµ„', 'è¨Š': 'è®¯', 'è™•': 'å¤„',
  'æ‡‰': 'åº”', 'è©²': 'è¯¥', 'ç•¶': 'å½“', 'ç™¼': 'å‘', 'ç¾': 'ç°',
  'å¯¦': 'å®', 'éš›': 'é™…', 'ç¶“': 'ç»', 'æ¿Ÿ': 'æµ', 'é«”': 'ä½“',
  'é©—': 'éªŒ', 'å­¸': 'å­¦', 'ç¿’': 'ä¹ ', 'æ¥­': 'ä¸š', 'å‹™': 'åŠ¡',
  'å“¡': 'å‘˜', 'å–®': 'å•', 'è¤‡': 'å¤', 'é›œ': 'æ‚', 'é›£': 'éš¾',
  'æº–': 'å‡†', 'å‚™': 'å¤‡', 'ç¢º': 'ç¡®', 'èª': 'è®¤', 'è©³': 'è¯¦',
  'ç´°': 'ç»†', 'ç¸½': 'æ€»', 'çµ': 'ç»“', 'è«–': 'è®º', 'è­°': 'è®®',
  'è¨': 'è®¨', 'è¨ˆ': 'è®¡', 'åŠƒ': 'åˆ’', 'æ›¸': 'ä¹¦', 'å¯«': 'å†™',
  'è®€': 'è¯»', 'è¨˜': 'è®°', 'éŒ„': 'å½•', 'è™Ÿ': 'å·', 'ç¢¼': 'ç ',
  'é¡': 'ç±»', 'åˆ¥': 'åˆ«', 'å€': 'åŒº', 'é¸': 'é€‰', 'æ“‡': 'æ‹©',
  'æ±º': 'å†³', 'è¨­': 'è®¾', 'èª¿': 'è°ƒ', 'è®Š': 'å˜', 'æ›': 'æ¢',
  'è½‰': 'è½¬', 'é‹': 'è¿', 'å‹•': 'åŠ¨', 'éœ': 'é™', 'æ…‹': 'æ€',
  'ç‹€': 'çŠ¶', 'æ³': 'å†µ', 'æ¢': 'æ¡', 'è¦': 'è§„', 'å‰‡': 'åˆ™',
  'æ¨™': 'æ ‡', 'åƒ¹': 'ä»·', 'è³ª': 'è´¨', 'é‡': 'é‡', 'æ•¸': 'æ•°',
  'æ“š': 'æ®', 'åº«': 'åº“', 'æª”': 'æ¡£', 'å¤¾': 'å¤¹', 'å±¤': 'å±‚',
  'ç´š': 'çº§', 'çµ„': 'ç»„', 'ç¹”': 'ç»‡', 'æ§‹': 'æ„', 'ç¯‰': 'ç­‘',
  'å‰µ': 'åˆ›', 'è£½': 'åˆ¶', 'ç”¢': 'äº§', 'é …': 'é¡¹', 'å»£': 'å¹¿',
  'æ±': 'ä¸œ', 'è»Š': 'è½¦', 'è¼›': 'è¾†', 'é£›': 'é£', 'ç·š': 'çº¿',
  'é–€': 'é—¨', 'æˆ¶': 'æˆ·', 'è¦–': 'è§†', 'é »': 'é¢‘', 'è²': 'å£°',
  'éŸ¿': 'å“', 'æ¨‚': 'ä¹', 'æ­¡': 'æ¬¢', 'è¬': 'è°¢', 'å¾©': 'å¤',
  'è¦†': 'å¤', 'è“‹': 'ç›–', 'æ»¿': 'æ»¡', 'é”': 'è¾¾', 'é›¢': 'ç¦»',
  'é–‰': 'é—­', 'å•Ÿ': 'å¯', 'ç¹¼': 'ç»§', 'çµ‚': 'ç»ˆ', 'é ­': 'å¤´',
  'è…¦': 'è„‘', 'è‡‰': 'è„¸', 'è…³': 'è„š', 'é¤Š': 'å…»', 'é†«': 'åŒ»',
  'ç™‚': 'ç–—', 'è—¥': 'è¯', 'éšª': 'é™©', 'æ­²': 'å²', 'é½¡': 'é¾„',
  'æ­·': 'å†', 'å±†': 'å±Š',
  // é¢å¤–è¡¥å……
  'èª': 'è¯­', 'è¨€': 'è¨€', 'éŸ³': 'éŸ³', 'åœ–': 'å›¾', 'ç•«': 'ç”»',
  'åƒ': 'åƒ', 'å½±': 'å½±', 'ç‰‡': 'ç‰‡', 'éŒ¢': 'é’±', 'å¹£': 'å¸',
  'é‘°': 'é’¥', 'åŒ™': 'åŒ™', 'éµ': 'é”®', 'ç›¤': 'ç›˜', 'è¢': 'è¤',
  'å¹•': 'å¹•', 'é¡¯': 'æ˜¾', 'ç¤º': 'ç¤º', 'è¼¸': 'è¾“', 'å…¥': 'å…¥',
  'è¼ª': 'è½®', 'è»Ÿ': 'è½¯', 'ç¡¬': 'ç¡¬', 'é«”': 'ä½“', 'çµ±': 'ç»Ÿ',
  'ä¿‚': 'ç³»', 'è¯': 'è”', 'ç¹«': 'ç³»', 'çµ¡': 'ç»œ', 'ç¶²': 'ç½‘',
  'éš›': 'é™…', 'é‚Š': 'è¾¹', 'ç·£': 'ç¼˜', 'ç·š': 'çº¿', 'ç´…': 'çº¢',
  'ç¶ ': 'ç»¿', 'è—': 'è“', 'é»ƒ': 'é»„', 'ç´«': 'ç´«', 'æ©™': 'æ©™',
  'é»‘': 'é»‘', 'ç™½': 'ç™½', 'ç°': 'ç°', 'éŠ€': 'é“¶', 'é‡‘': 'é‡‘',
  'éµ': 'é“', 'éŠ…': 'é“œ', 'é‹': 'é“', 'é‹¼': 'é’¢', 'éŒ«': 'é”¡',
  'é‹°': 'é”‚', 'é›»': 'ç”µ', 'æ± ': 'æ± ', 'å……': 'å……', 'æ»¿': 'æ»¡',
  'é¤˜': 'ä½™', 'é¡': 'é¢', 'å¸³': 'è´¦', 'æˆ¶': 'æˆ·', 'è™Ÿ': 'å·',
  'å¯†': 'å¯†', 'ç¢¼': 'ç ', 'é©—': 'éªŒ', 'è­‰': 'è¯', 'ç¢¼': 'ç ',
  'è¨ª': 'è®¿', 'å•': 'é—®', 'è©¢': 'è¯¢', 'è«®': 'å’¨', 'è©¢': 'è¯¢',
  'æ­¸': 'å½’', 'é‚„': 'è¿˜', 'é ': 'è¿œ', 'è¿‘': 'è¿‘', 'è£': 'é‡Œ',
  'éºµ': 'é¢', 'éº¼': 'ä¹ˆ', 'ç‚º': 'ä¸º', 'ç„¡': 'æ— ', 'èˆ‡': 'ä¸',
  'å¾': 'ä»', 'ä¾†': 'æ¥', 'æ±': 'ä¸œ', 'è¥¿': 'è¥¿', 'å—': 'å—',
  'åŒ—': 'åŒ—', 'å…§': 'å†…', 'å¤–': 'å¤–', 'è£': 'è£…', 'è¼‰': 'è½½',
  'å‚³': 'ä¼ ', 'è¼¸': 'è¾“', 'å°': 'å¯¼', 'èˆª': 'èˆª', 'éŠ': 'æ¸¸',
  'è¦½': 'è§ˆ', 'ç€': 'æµ', 'è¦½': 'è§ˆ', 'ç¶²': 'ç½‘', 'é ': 'é¡µ',
  'éˆ': 'é“¾', 'çµ': 'ç»“', 'é€£': 'è¿', 'æ¥': 'æ¥', 'æ–·': 'æ–­',
  'é–‹': 'å¼€', 'é—œ': 'å…³', 'é–‰': 'é—­', 'é–': 'é”', 'è§£': 'è§£',
  'é–': 'é”', 'åŠ ': 'åŠ ', 'æ¸›': 'å‡', 'ä¹˜': 'ä¹˜', 'é™¤': 'é™¤',
  'ç©': 'ç§¯', 'é¤˜': 'ä½™', 'å€': 'å€', 'é›™': 'åŒ', 'å°': 'å¯¹',
  'ç¨±': 'ç§°', 'è¡¡': 'è¡¡', 'æ¸¬': 'æµ‹', 'è©¦': 'è¯•', 'é©—': 'éªŒ',
  'æª¢': 'æ£€', 'æŸ¥': 'æŸ¥', 'æ ¸': 'æ ¸', 'å¯©': 'å®¡', 'æ‰¹': 'æ‰¹',
  'æº–': 'å‡†', 'è¨±': 'è®¸', 'å¯': 'å¯', 'ç¦': 'ç¦', 'æ­¢': 'æ­¢',
  'é™': 'é™', 'åˆ¶': 'åˆ¶', 'ç´„': 'çº¦', 'æŸ': 'æŸ', 'ç¶': 'ç»‘',
  'å®š': 'å®š', 'ç¾©': 'ä¹‰', 'æ„': 'æ„', 'ç¾©': 'ä¹‰', 'æ€': 'æ€',
  'æƒ³': 'æƒ³', 'å¿µ': 'å¿µ', 'æ…®': 'è™‘', 'æ†‚': 'å¿§', 'æ„': 'æ„',
  'ç…©': 'çƒ¦', 'æƒ±': 'æ¼', 'æ“”': 'æ‹…', 'å¿ƒ': 'å¿ƒ', 'æ”¾': 'æ”¾',
  'é¬†': 'æ¾', 'ç·Š': 'ç´§', 'å¼µ': 'å¼ ', 'å£“': 'å‹', 'åŠ›': 'åŠ›',
  'å¼·': 'å¼º', 'å¼±': 'å¼±', 'è»Ÿ': 'è½¯', 'ç¡¬': 'ç¡¬', 'è„†': 'è„†',
  'éŸŒ': 'éŸ§', 'å½ˆ': 'å¼¹', 'æ€§': 'æ€§', 'å¡‘': 'å¡‘', 'è† ': 'èƒ¶',
  'ç´™': 'çº¸', 'å¼µ': 'å¼ ', 'é ': 'é¡µ', 'å†Š': 'å†Œ', 'å·': 'å·',
  'è»¸': 'è½´', 'è¼ª': 'è½®', 'ç›¤': 'ç›˜', 'ç¢Ÿ': 'ç¢Ÿ', 'ç‰‡': 'ç‰‡',
  'å¸¶': 'å¸¦', 'æ¢': 'æ¡', 'ç¹©': 'ç»³', 'ç´¢': 'ç´¢', 'éˆ': 'é“¾',
  'ç’°': 'ç¯', 'åœˆ': 'åœˆ', 'è¼ª': 'è½®', 'è¿´': 'å›', 'è½‰': 'è½¬',
  'æ—‹': 'æ—‹', 'ç¹': 'ç»•', 'çº': 'ç¼ ', 'æ²': 'å·', 'æ‘º': 'æŠ˜',
  'ç–Š': 'å ', 'å †': 'å †', 'ç©': 'ç§¯', 'èš': 'èš', 'é›†': 'é›†',
  'æ•£': 'æ•£', 'ä½ˆ': 'å¸ƒ', 'åˆ†': 'åˆ†', 'é…': 'é…', 'ç™¼': 'å‘',
  'é€': 'é€', 'é': 'é€’', 'å¯„': 'å¯„', 'éƒµ': 'é‚®', 'ä»¶': 'ä»¶',
  'åŒ…': 'åŒ…', 'è£¹': 'è£¹', 'ç®±': 'ç®±', 'æ«ƒ': 'æŸœ', 'æ¶': 'æ¶',
  'è‡º': 'å°', 'æª¯': 'å°', 'æ¡Œ': 'æ¡Œ', 'æ¤…': 'æ¤…', 'å‡³': 'å‡³',
  'ç‰€': 'åºŠ', 'é‹ª': 'é“º', 'å¢Š': 'å«', 'æ•': 'æ•', 'è¢«': 'è¢«',
  'æ¯¯': 'æ¯¯', 'ç°¾': 'å¸˜', 'å¹•': 'å¹•', 'çª—': 'çª—', 'æˆ¶': 'æˆ·',
  'é–€': 'é—¨', 'å»³': 'å…', 'å ‚': 'å ‚', 'å®¤': 'å®¤', 'æˆ¿': 'æˆ¿',
  'é–“': 'é—´', 'å»š': 'å¨', 'è¡›': 'å«', 'æµ´': 'æµ´', 'å»': 'å•',
  'æ‰€': 'æ‰€', 'æ¨“': 'æ¥¼', 'å±¤': 'å±‚', 'æ¢¯': 'æ¢¯', 'éš': 'é˜¶',
  'ç´š': 'çº§', 'è‡º': 'å°', 'éš': 'é˜¶', 'å¡': 'å¡', 'é“': 'é“',
  'å¾‘': 'å¾„', 'é€”': 'é€”', 'ç¨‹': 'ç¨‹', 'è·': 'è·', 'é›¢': 'ç¦»',
  'é ': 'è¿œ', 'è¿‘': 'è¿‘', 'é«˜': 'é«˜', 'ä½': 'ä½', 'æ·±': 'æ·±',
  'æ·º': 'æµ…', 'å¯¬': 'å®½', 'çª„': 'çª„', 'åš': 'åš', 'è–„': 'è–„',
  'ç²—': 'ç²—', 'ç´°': 'ç»†', 'å¤§': 'å¤§', 'å°': 'å°', 'å·¨': 'å·¨',
  'å¾®': 'å¾®', 'æ¥µ': 'æ', 'ç«¯': 'ç«¯', 'é ‚': 'é¡¶', 'åº•': 'åº•',
  'é‚Š': 'è¾¹', 'è§’': 'è§’', 'é¢': 'é¢', 'å´': 'ä¾§', 'æ—': 'æ—',
  'é€±': 'å‘¨', 'åœ': 'å›´', 'ç¹': 'ç»•', 'ç’°': 'ç¯', 'è¿´': 'å›',
  'å¾©': 'å¤', 'è¿”': 'è¿”', 'æ­¸': 'å½’', 'é‚„': 'è¿˜', 'ä¾†': 'æ¥',
  'å¾€': 'å¾€', 'å»': 'å»', 'é›¢': 'ç¦»', 'é–‹': 'å¼€', 'åˆ°': 'åˆ°',
  'é”': 'è¾¾', 'æŠµ': 'æŠµ', 'è‡³': 'è‡³', 'åŠ': 'åŠ', 'å¤ ': 'å¤Ÿ',
  'è¶³': 'è¶³', 'æ»¿': 'æ»¡', 'ç›ˆ': 'ç›ˆ', 'æº¢': 'æº¢', 'æ¼': 'æ¼',
  'æ´©': 'æ³„', 'æ¼': 'æ¼', 'æ»²': 'æ¸—', 'é€': 'é€', 'ç©¿': 'ç©¿',
  'é': 'è¿‡', 'è¶Š': 'è¶Š', 'è·¨': 'è·¨', 'èº': 'è·ƒ', 'è·³': 'è·³',
  'è¹¦': 'è¹¦', 'å½ˆ': 'å¼¹', 'è·‘': 'è·‘', 'èµ°': 'èµ°', 'è¡Œ': 'è¡Œ',
  'æ­¥': 'æ­¥', 'é‚': 'è¿ˆ', 'è¸': 'è¸', 'è¸©': 'è¸©', 'è¹¬': 'è¹¬',
  'è¸¢': 'è¸¢', 'è¸¹': 'è¸¹', 'è·º': 'è·º', 'è¹²': 'è¹²', 'ç«™': 'ç«™',
  'ç«‹': 'ç«‹', 'å': 'å', 'èºº': 'èºº', 'è‡¥': 'å§', 'è¶´': 'è¶´',
  'è·ª': 'è·ª', 'çˆ¬': 'çˆ¬', 'æ”€': 'æ”€', 'ç™»': 'ç™»', 'å‡': 'å‡',
  'é™': 'é™', 'è½': 'è½', 'å¢œ': 'å ', 'æ‰': 'æ‰', 'ä¸Ÿ': 'ä¸¢',
  'å¤±': 'å¤±', 'éº': 'é—', 'å¿˜': 'å¿˜', 'è¨˜': 'è®°', 'æ†¶': 'å¿†',
  'æƒ³': 'æƒ³', 'å¿µ': 'å¿µ', 'æ€': 'æ€', 'è€ƒ': 'è€ƒ', 'æ…®': 'è™‘',
  'ç®—': 'ç®—', 'è¨ˆ': 'è®¡', 'åŠƒ': 'åˆ’', 'ç­–': 'ç­–', 'è¬€': 'è°‹',
  'åœ–': 'å›¾', 'è¬€': 'è°‹', 'åŠƒ': 'åˆ’', 'è¨­': 'è®¾', 'è¨ˆ': 'è®¡',
  'ç•«': 'ç”»', 'ç¹ª': 'ç»˜', 'æ': 'æ', 'å¯«': 'å†™', 'åˆ»': 'åˆ»',
  'é›•': 'é›•', 'å¡‘': 'å¡‘', 'é‘„': 'é“¸', 'é€ ': 'é€ ', 'è£½': 'åˆ¶',
  'ä½œ': 'ä½œ', 'åš': 'åš', 'å¹¹': 'å¹²', 'æ': 'æ', 'å¼„': 'å¼„',
  'æ•´': 'æ•´', 'ç†': 'ç†', 'æ”¶': 'æ”¶', 'æ‹¾': 'æ‹¾', 'æ’¿': 'æ¡',
  'æ‹¿': 'æ‹¿', 'å–': 'å–', 'å¾—': 'å¾—', 'ç²': 'è·', 'è´': 'èµ¢',
  'è¼¸': 'è¾“', 'æ•—': 'è´¥', 'å‹': 'èƒœ', 'è´': 'èµ¢', 'è™§': 'äº',
  'æ': 'æŸ', 'å¤±': 'å¤±', 'ç›Š': 'ç›Š', 'åˆ©': 'åˆ©', 'æ½¤': 'æ¶¦',
  'è³º': 'èµš', 'æ™': 'æŒ£', 'è³ ': 'èµ”', 'å„Ÿ': 'å¿', 'é‚„': 'è¿˜',
  'ä»˜': 'ä»˜', 'æ¬¾': 'æ¬¾', 'è²»': 'è´¹', 'ç¨…': 'ç¨', 'æ': 'æ',
  'ç»': 'çŒ®', 'è´ˆ': 'èµ ', 'é€': 'é€', 'çµ¦': 'ç»™', 'äºˆ': 'äºˆ',
  'æˆ': 'æˆ', 'å—': 'å—', 'æ¥': 'æ¥', 'æ”¶': 'æ”¶', 'é ˜': 'é¢†',
  'å–': 'å–', 'æ‹¿': 'æ‹¿', 'æ¡': 'æ¡', 'æŒ': 'æŒ', 'åŸ·': 'æ‰§',
  'æŒ': 'æŒ', 'æ§': 'æ§', 'åˆ¶': 'åˆ¶', 'ç®¡': 'ç®¡', 'ç†': 'ç†',
  'æ²»': 'æ²»', 'ç™‚': 'ç–—', 'é†«': 'åŒ»', 'è­·': 'æŠ¤', 'é¤Š': 'å…»',
  'è‚²': 'è‚²', 'åŸ¹': 'åŸ¹', 'è¨“': 'è®­', 'ç·´': 'ç»ƒ', 'ç¿’': 'ä¹ ',
  'å­¸': 'å­¦', 'æ•™': 'æ•™', 'å°': 'å¯¼', 'å¼•': 'å¼•', 'é ˜': 'é¢†',
  'å¸¶': 'å¸¦', 'ç‡': 'ç‡', 'é ˜': 'é¢†', 'å°': 'å¯¼', 'æŒ‡': 'æŒ‡',
  'æ®': 'æŒ¥', 'å‘½': 'å‘½', 'ä»¤': 'ä»¤', 'å©': 'å©', 'å’': 'å’',
  'å›‘': 'å˜±', 'è¨—': 'æ‰˜', 'å§”': 'å§”', 'æ´¾': 'æ´¾', 'é£': 'é£',
  'èª¿': 'è°ƒ', 'é…': 'é…', 'åˆ†': 'åˆ†', 'æ’¥': 'æ‹¨', 'åŠƒ': 'åˆ’',
  'æ­¸': 'å½’', 'å±¬': 'å±', 'éš¸': 'éš¶', 'å±¬': 'å±', 'å¾': 'ä»',
  'å±¬': 'å±', 'ä¾': 'ä¾', 'é™„': 'é™„', 'é ': 'é ', 'å€š': 'å€š',
  'è³´': 'èµ–', 'ä»—': 'ä»—', 'æ†‘': 'å‡­', 'è—‰': 'å€Ÿ', 'å€Ÿ': 'å€Ÿ',
  'è²¸': 'è´·', 'ç§Ÿ': 'ç§Ÿ', 'è³ƒ': 'èµ', 'åƒ±': 'é›‡', 'å‚­': 'ä½£',
  'è˜': 'è˜', 'è«‹': 'è¯·', 'é‚€': 'é‚€', 'ç´„': 'çº¦', 'è¨‚': 'è®¢',
  'é ': 'é¢„', 'å®š': 'å®š', 'ç¢º': 'ç¡®', 'èª': 'è®¤', 'æ ¸': 'æ ¸',
  'å¯¦': 'å®', 'è­‰': 'è¯', 'æ˜': 'æ˜', 'é¡¯': 'æ˜¾', 'ç¤º': 'ç¤º',
  'è¡¨': 'è¡¨', 'é”': 'è¾¾', 'å‚³': 'ä¼ ', 'é': 'é€’', 'é€': 'é€',
  'é”': 'è¾¾', 'åˆ°': 'åˆ°', 'æŠµ': 'æŠµ', 'è‡³': 'è‡³', 'åŠ': 'åŠ'
};

/**
 * ç¹ä½“è½¬ç®€ä½“
 */
export function toSimplified(text) {
  if (!text) return text;
  
  let result = text;
  for (const [trad, simp] of Object.entries(TRAD_TO_SIMP)) {
    result = result.replace(new RegExp(trad, 'g'), simp);
  }
  return result;
}

/**
 * æ ¼å¼åŒ– AI è¾“å‡º
 * - è½¬æ¢ä¸ºç®€ä½“ä¸­æ–‡
 * - ç¡®ä¿ Markdown æ ¼å¼æ­£ç¡®
 */
export function formatAIOutput(text) {
  if (!text) return '';
  
  // 1. è½¬æ¢ä¸ºç®€ä½“ä¸­æ–‡
  let formatted = toSimplified(text);
  
  // 2. ä¿®å¤å¸¸è§ Markdown é—®é¢˜
  formatted = fixMarkdown(formatted);
  
  return formatted;
}

/**
 * ä¿®å¤ Markdown æ ¼å¼é—®é¢˜
 */
export function fixMarkdown(text) {
  let result = text;
  
  // ä¿®å¤æ ‡é¢˜æ ¼å¼ï¼ˆç¡®ä¿ # åæœ‰ç©ºæ ¼ï¼‰
  result = result.replace(/^(#{1,6})([^#\s])/gm, '$1 $2');
  
  // ä¿®å¤åˆ—è¡¨æ ¼å¼ï¼ˆç¡®ä¿ - åæœ‰ç©ºæ ¼ï¼‰
  result = result.replace(/^(\s*)-([^\s])/gm, '$1- $2');
  
  // ä¿®å¤ç²—ä½“æ ¼å¼
  result = result.replace(/\*\*\s+/g, '**');
  result = result.replace(/\s+\*\*/g, '**');
  
  // ä¿®å¤ä»£ç å—
  result = result.replace(/```(\w+)\n/g, '```$1\n');
  
  return result;
}

/**
 * æ ¼å¼åŒ–ä»ªè¡¨ç›˜ï¼ˆç²¾ç®€ç‰ˆï¼‰
 */
export function formatDashboard(data) {
  const { messageCount, model, tokens, timestamp } = data;
  const time = timestamp || new Date().toLocaleTimeString('zh-CN', { 
    hour: '2-digit', 
    minute: '2-digit' 
  });
  
  // ç²¾ç®€å•è¡Œæ ¼å¼
  return `\nâ”€â”€â”€\nğŸ“Š #${messageCount || 0} | ${model || 'AI'} | ${tokens || 0}t | ${time}`;
}

/**
 * æ ¼å¼åŒ–ç­¾è¯å’¨è¯¢ç»“æœ
 */
export function formatVisaResponse(response, expandedQuestions = []) {
  let formatted = toSimplified(response);
  
  // æ·»åŠ æ‰©å±•é—®é¢˜ï¼ˆå¦‚æœæœ‰ï¼‰
  if (expandedQuestions.length > 0) {
    formatted += `\n\n---\n### ğŸ”— ç›¸å…³é—®é¢˜\n`;
    expandedQuestions.forEach((q, i) => {
      formatted += `${i + 1}. ${toSimplified(q)}\n`;
    });
  }
  
  return formatted;
}

/**
 * æ ¼å¼åŒ–ä¾¿ç­¾åˆ—è¡¨
 */
export function formatNotesList(notes) {
  if (!notes || notes.length === 0) {
    return 'ğŸ“‹ **ä½ çš„ä¾¿ç­¾**\n\nè¿˜æ²¡æœ‰ä»»ä½•ä¾¿ç­¾ï¼Œç‚¹å‡»ã€Œæ–°å»ºä¾¿ç­¾ã€åˆ›å»ºä¸€ä¸ªå§ï¼';
  }
  
  let text = 'ğŸ“‹ **ä½ çš„ä¾¿ç­¾**\n\n';
  notes.forEach((note, i) => {
    const date = new Date(note.createdAt).toLocaleDateString('zh-CN');
    const title = toSimplified(note.title);
    const content = toSimplified(note.content).substring(0, 50);
    text += `${i + 1}. **${title}**\n   ${content}${note.content.length > 50 ? '...' : ''}\n   ğŸ“… ${date}\n\n`;
  });
  
  return text;
}

/**
 * æ ¼å¼åŒ–é”™è¯¯æ¶ˆæ¯
 */
export function formatError(error) {
  return `âŒ **é”™è¯¯**: ${toSimplified(error.message || String(error))}`;
}

/**
 * Telegram Markdown è½¬ä¹‰
 * è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ä»¥é¿å…è§£æé”™è¯¯
 */
export function escapeTelegramMd(text) {
  if (!text) return '';
  
  // Telegram MarkdownV2 éœ€è¦è½¬ä¹‰çš„å­—ç¬¦
  // ä½†æˆ‘ä»¬ä½¿ç”¨ Markdown æ¨¡å¼ï¼Œåªéœ€å¤„ç†éƒ¨åˆ†
  return text
    .replace(/([_*\[\]()~`>#+\-=|{}.!])/g, '\\$1');
}

/**
 * å®‰å…¨çš„ Markdown æ ¼å¼åŒ–
 * ç”¨äº Telegram å‘é€
 */
export function safeMd(text) {
  if (!text) return '';
  
  // å…ˆè½¬ç®€ä½“
  let result = toSimplified(text);
  
  // ç¡®ä¿ Markdown æ ¼å¼æ­£ç¡®
  result = fixMarkdown(result);
  
  return result;
}

export default {
  toSimplified,
  formatAIOutput,
  fixMarkdown,
  formatDashboard,
  formatVisaResponse,
  formatNotesList,
  formatError,
  escapeTelegramMd,
  safeMd
};
